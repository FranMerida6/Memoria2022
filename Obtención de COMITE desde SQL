print('Comienzo de comité')
#COMITÉ.
import pyodbc
import cx_Oracle
import pandas as pd
#Importar data desde ORACLE.
dsn = cx_Oracle.makedsn('172.21.0.103','1521',service_name='repopehcos')
BBDDREMI = cx_Oracle.connect("REPORTE", "REPORTERIA", dsn)
df_comite=pd.read_sql("""WITH TABLA_COMITE

(IDENTIFICADOR,
 NUMERO_DOCUMENTO,
 NUMERO_FICHA,
 PACIENTE, 
 ID_RESOLUCION_COMITE,
 TIPO,       
 DIAGNOSTICO,
 CODIGO,
TIPO_PLAN_PROPUESTO,
PLAN_PROPUESTO,
CODIGO_PLAN_P,
LATERALIDAD_PLAN_P,
ES_PRINCIPAL_P,
PLAN_RESUELTO,
CODIGO_PLAN_R,
 LATERAILIDAD_PLAN_R,
ES_PRINCIPAL,
NUMERO_PLAN_SICI_QTA,
OTRO_TRATAMIENTO,
INTENCION_TRAT,
FUNDAMENTO_RESO,
 FH_FIRMA,
 FECHA_FIRMA,
 HORA_FIRMA,
 NOMBRE_PROFESIONAL,
 CONSIDERAR
 ) 
AS
 (

SELECT
  
  CASE WHEN DOC.DOC_TYPE_KEY = 2010158 THEN 'RUT' ELSE
  CASE WHEN DOC.DOC_TYPE_KEY = 2011804 THEN 'DNI' ELSE
  CASE WHEN DOC.DOC_TYPE_KEY = 2001814 THEN 'Pasaporte'
  ELSE 'ERROR'
        END END END AS IDENTIFICADOR
 
 , DOC.DOC_NUMBER AS NUMERO_DOCUMENTO      
 , PAT.CHN                       AS NUMERO_FICHA
 ,PAT.SURNAME1|| ' ' ||PAT.SURNAME2|| ' ' ||PAT.NAME  AS PACIENTE
 ,RES.OC_COMMITTEE_RESOLUTION_KEY AS ID_RESOLUCION_COMITE
--,RES.CR_SUMMARY                 AS RESUMEN_DEL_CASO_CLINICO
,LBL13.DEFAULT_TEXT               AS TIPO
,LBL.DEFAULT_TEXT               AS DIAGNOSTICO
,LBL2.DEFAULT_TEXT             AS CODIGO
,LBL3.DEFAULT_TEXT              AS TIPO_PLAN_PROPUESTO
,LBL4.DEFAULT_TEXT              AS PLAN_PROPUESTO
,LBL12.DEFAULT_TEXT             AS CODIGO_PLAN_P
,LBL5.DEFAULT_TEXT              AS LATERALIDAD_PLAN_P
,PROCED.PRINCIPAL               AS ES_PRINCIPAL_P
,LBL6.DEFAULT_TEXT              AS PLAN_RESUELTO
,LBL11.DEFAULT_TEXT             AS CODIGO_PLAN_R
,LBL7.DEFAULT_TEXT              AS LATERAILIDAD_PLAN_R
,PROCE.IS_MAIN                  AS ES_PRINCIPAL
,CHEM.SICI_PLANTTO_ID           AS NUMERO_PLAN_SICI_QTA
,OTHER_TREATMENT                AS OTRO_TRATAMIENTO
,LBL9.DEFAULT_TEXT              AS INTENCION_TRAT
,LBL10.DEFAULT_TEXT             AS FUNDAMENTO_RESO
--,RES.OBSERVATION                AS OBSERVACION
,RES.SIGN_DATE                  AS FH_FIRMA
,TO_DATE(TO_CHAR(RES.SIGN_DATE, 'DD/MM/YYYY'), 'DD/MM/YYYY')  AS FECHA_FIRMA
,TO_CHAR(RES.SIGN_DATE, 'HH24:MI:SS') AS HORA_FIRMA
,US.SURNAME1|| ' ' ||US.SURNAME2|| ' ' ||US.NAME as NOMBRE_PROFESIONAL

,CASE WHEN ROW_NUMBER () OVER (PARTITION BY RES.OC_COMMITTEE_RESOLUTION_KEY ORDER BY RES.SIGN_DATE DESC)=1 THEN 1 ELSE 0 END AS CONSIDERAR


FROM EHCS.OC_COMMITTEE_RESOLUTION RES

LEFT JOIN EHCS.OC_PROCE_RESOL PROCE ON RES.OC_COMMITTEE_RESOLUTION_KEY=PROCE.COMMITTEE_RESOLUTION_KEY
LEFT JOIN EHCS.OC_RESOLUTION_MEMBER MEM ON RES.OC_COMMITTEE_RESOLUTION_KEY=MEM.COMMITTEE_RESOLUTION_KEY
LEFT JOIN EHCS.CLINICA_DIAGNOSTI_EPISOD CD ON RES.EPISODE_KEY = CD.EPISODE_KEY
LEFT JOIN EHCS.CLINICAL_DIAGNOSTIC  CLI ON CD.CLINICAL_DIAGNOSTIC_KEY= CLI.CLINICAL_DIAGNOSTIC_KEY
LEFT JOIN EHCOS.CATALOG_CONTENT CON ON CLI.CATALOG_CONTENT_KEY=CON.CATALOG_CONTENT_KEY
LEFT JOIN HEALTH_KERNEL.PATIENT PAT ON RES.PATIENT_KEY=PAT.PATIENT_KEY
LEFT JOIN HEALTH_KERNEL.CATALOG_LOCAL_TERMS TER ON CLI.CATALOG_LOCAL_TERMS_KEY=TER.CATALOG_LOCAL_TERMS_KEY
LEFT JOIN EHCOS.LABEL LBL ON TER.LABEL_LONG_DESC =LBL.LABEL_CODE
LEFT JOIN EHCOS.LABEL LBL2 ON TER.LABEL_SHORT_DESC=LBL2.LABEL_CODE
LEFT JOIN  EHCS.TREATMENT_PLAN PLAN ON RES.TREATMENT_PLAN_KEY=PLAN.TREATMENT_PLAN_KEY
LEFT JOIN  EHCOS.TYPE_MASTER TYP ON PLAN.TREATMENT_PLAN_TYPE_KEY=TYP.TYPE_MASTER_KEY
LEFT JOIN  EHCOS.LABEL LBL3 ON TYP.LONG_DESC_LABEL=LBL3.LABEL_CODE
LEFT JOIN  EHCS.TREATMENT_PLAN_PROCEDURE PROCED ON PLAN.TREATMENT_PLAN_KEY=PROCED.TREATMENT_PLAN_KEY
LEFT JOIN  HEALTH_KERNEL.RENDERING_MASTER  REN ON  PROCED.PROCEDURE_KEY = REN.RENDERING_MASTER_KEY
LEFT JOIN HEALTH_KERNEL.DOCS_IDENTIFIED DOC ON DOC.PATIENT_KEY = PAT.PATIENT_KEY
LEFT JOIN  EHCOS.LABEL LBL4 ON REN.LONG_DESC_LABEL=LBL4.LABEL_CODE
LEFT JOIN  EHCOS.LABEL LBL12 ON REN.SHORT_DESC_LABEL=LBL12.LABEL_CODE
LEFT JOIN  EHCOS.TYPE_MASTER TYP2 ON PROCED.LATERALITY_KEY=TYP2.TYPE_MASTER_KEY
LEFT JOIN  EHCOS.LABEL LBL5 ON TYP2.LONG_DESC_LABEL = LBL5.LABEL_CODE
LEFT JOIN  HEALTH_KERNEL.RENDERING_MASTER  REN1 ON  PROCE.PROCEDURE_KEY = REN1.RENDERING_MASTER_KEY
LEFT JOIN  EHCOS.LABEL LBL6 ON REN1.LONG_DESC_LABEL=LBL6.LABEL_CODE
LEFT JOIN  EHCOS.LABEL LBL11 ON REN1.SHORT_DESC_LABEL=LBL11.LABEL_CODE
LEFT JOIN  EHCOS.TYPE_MASTER TYP3 ON PROCE.LATERALITY_KEY=TYP3.TYPE_MASTER_KEY
LEFT JOIN  EHCOS.LABEL LBL7 ON TYP3.LONG_DESC_LABEL = LBL7.LABEL_CODE
LEFT JOIN  EHCOS.TYPE_MASTER TYP4 ON RES.INTENT_TO_TREAT_TYPE_KEY=TYP4.TYPE_MASTER_KEY
LEFT JOIN  EHCOS.LABEL LBL9 ON  TYP4.LONG_DESC_LABEL=LBL9.LABEL_CODE
LEFT JOIN  EHCOS.TYPE_MASTER TYP5 ON RES.RESOL_FUND_TYPE_KEY=TYP5.TYPE_MASTER_KEY
LEFT JOIN  EHCOS.LABEL LBL10 ON  TYP4.LONG_DESC_LABEL=LBL10.LABEL_CODE
LEFT JOIN  EHCOS.PROFESSIONAL PROFE ON RES.PROFESSIONAL_SIGN_KEY= PROFE.PROFESSIONAL_KEY
LEFT JOIN  EHCOS.EH_USER US ON PROFE.USER_KEY=US.USER_KEY
LEFT JOIN EHCS.CHEMICAL_TREATMENT_PLAN CHEM ON RES.TREATMENT_PLAN_KEY=CHEM.TREATMENT_PLAN_KEY
LEFT JOIN HEALTH_KERNEL.RENDERING_MASTER REN2 ON MEM.COMMITTE_KEY=REN2.RENDERING_MASTER_KEY
LEFT JOIN  EHCOS.LABEL LBL13 ON REN2.LONG_DESC_LABEL=LBL13.LABEL_CODE


WHERE  RES.DELETED=0 AND MEM.DELETED=0 --AND CONSIDERAR=1
AND to_date(to_char(RES.SIGN_DATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') >= to_date('2018-01-01', 'YYYY-MM-DD')
AND to_date(to_char(RES.SIGN_DATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') <= to_date('2022-10-31', 'YYYY-MM-DD')
order by RES.SIGN_DATE

)

select *
FROM TABLA_COMITE
WHERE CONSIDERAR =1""",BBDDREMI)






ruta='C:/Users/edgar/Downloads/RESPALDO/df_comite_respaldo.csv'
df_comite.to_csv(path_or_buf=ruta)
