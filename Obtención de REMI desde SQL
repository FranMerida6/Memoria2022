print('Comienzo de REMI')
#REMI.
import pyodbc
import cx_Oracle
import pandas as pd
dsn=cx_Oracle.makedsn('172.21.0.103','1521',service_name='repopehcos')
BBDDREMI=cx_Oracle.connect("REPORTE","REPORTERIA",dsn)
df_global=pd.read_sql("""SELECT DISTINCT
PAT.CHN AS FICHA,
DOC.DOC_NUMBER AS ID_PACIENTE,
PAT.NAME||' '||PAT.SURNAME1||' '||PAT.SURNAME2 AS NOMBRE_PACIENTE,
PLAN.TREATMENT_PLAN_KEY AS ID_PLAN,
PLAN.INSERT_DATE AS fecha_insercion_plan,
PLAN.SIGN_DATE AS FECHA_FIRMA,
LBL.DEFAULT_TEXT AS TIPO,
LBL1.DEFAULT_TEXT AS PROCEDIMIENTO_PRINCIPAL,
US.NAME||' '||US.SURNAME1||' '||US.SURNAME2 AS NOMBRE_PROFESIONAL,
LBL2.DEFAULT_TEXT AS CONSENTIMIENTO,
CON.DELIVERED_TO_PATIENT_DATE AS FECHA_ENTREGA_PACIENTE,
CON.SIGN_DATE AS FECHA_FIRMADO



--SELECT *
FROM EHCS.TREATMENT_PLAN PLAN
INNER JOIN EHCOS.TYPE_MASTER TY ON PLAN.TREATMENT_TYPE_KEY = TY.TYPE_MASTER_KEY
INNER JOIN EHCOS.LABEL LBL  ON TY.LONG_DESC_LABEL=LBL.LABEL_CODE
INNER JOIN EHCS.TREATMENT_PLAN_PROCEDURE PRO ON PLAN.TREATMENT_PLAN_KEY=PRO.TREATMENT_PLAN_KEY
INNER JOIN HEALTH_KERNEL.RENDERING_MASTER MAS ON PRO.PROCEDURE_KEY=MAS.RENDERING_MASTER_KEY
INNER JOIN EHCOS.LABEL LBL1 ON MAS.LONG_DESC_LABEL=LBL1.LABEL_CODE
INNER JOIN HEALTH_KERNEL.EPISODE EPI ON PLAN.EPISODE_KEY=EPI.EPISODE_KEY
INNER JOIN HEALTH_KERNEL.PATIENT PAT ON EPI.PATIENT_KEY=PAT.PATIENT_KEY
INNER JOIN HEALTH_KERNEL.DOCS_IDENTIFIED DOC  ON PAT.PATIENT_KEY=DOC.PATIENT_KEY
INNER JOIN EHCOS.PROFESSIONAL PRO ON PLAN.TRAITING_DOCTOR_KEY=PRO.PROFESSIONAL_KEY
INNER JOIN EHCOS.EH_USER US ON PRO.USER_KEY=US.USER_KEY
LEFT JOIN HEALTH_KERNEL.PATIENT_INFORMED_CONSENT CON ON PLAN.TREATMENT_PLAN_KEY= CON.ELEMENT_KEY
LEFT JOIN EHCOS.TYPE_MASTER TYP2 ON CON.INFORMED_CONSENT_STATUS_KEY=TYP2.TYPE_MASTER_KEY
LEFT JOIN EHCOS.LABEL LBL2 ON TYP2.LONG_DESC_LABEL=LBL2.LABEL_CODE
WHERE PRO.PRINCIPAL=1 AND PLAN.DELETED=0 --AND PAT.CHN='225451' --AND PLAN.TREATMENT_PLAN_KEY='10011580'
AND to_date(to_char(CON.SIGN_DATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') >= to_date('2018-01-01', 'YYYY-MM-DD')
AND to_date(to_char(CON.SIGN_DATE, 'YYYY-MM-DD'), 'YYYY-MM-DD') <= to_date('2022-10-31', 'YYYY-MM-DD')

order by PLAN.SIGN_DATE""",BBDDREMI)


ruta='C:/Users/edgar/Downloads/RESPALDO/df_global_respaldo.csv'
df_global.to_csv(path_or_buf=ruta)
